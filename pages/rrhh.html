<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Dashboard Recursos Humanos</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    /* Base (tema claro) */
    body { background: #f3f4f6; color: #1f2937; }
    header { background: #0f766e; color: #fff; }
    .card { background: #fff; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .chart-card { height: 280px; }
    .chart-card canvas { width: 100% !important; height: 100% !important; }
    input, select { background: #fff; border: 1px solid #d1d5db; color: #1f2937; }
    table thead { background: #e5e7eb; }
    button { background: #e5e7eb; color: #1f2937; }

    /* Dark mode */
    html.dark body { background: #0f172a; color: #f9fafb; }
    html.dark header { background: #0f766e; color: #fff; }
    html.dark .card { background: #1e293b; color: #f9fafb; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
    html.dark input, html.dark select { background: #1e293b; border-color: #334155; color: #f9fafb; }
    html.dark table thead { background: #334155; color: #f9fafb; }
    html.dark button { background: #334155; color: #f9fafb; }
    html.dark .bg-green-100 { background-color: #065f46 !important; color: #a7f3d0 !important; }
    html.dark .bg-red-100 { background-color: #7f1d1d !important; color: #fecaca !important; }
    .card, p, h2 {
  transition: background-color 0.3s, color 0.3s;
}
  </style>
    <script>
    (function() {
      try {
        if (localStorage.getItem('darkMode') === 'enabled') {
          document.documentElement.classList.add('dark');
        }
      } catch(e) {}
    })();
  </script>
  <script>
  tailwind.config = {
    darkMode: 'class'
  }
</script>
</head>

<body class="min-h-screen">

  <!-- HEADER -->
  <header class="p-6 shadow flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold">Dashboard de Recursos Humanos</h1>
      <p class="text-sm opacity-90">Control y seguimiento de fichajes</p>
    </div>
    <button onclick="window.location.href='../features/settings.html'" aria-label="Abrir configuración de usuario" title="Configuración"
      class="w-10 h-10 rounded-full bg-white dark:bg-gray-700 flex items-center justify-center shadow hover:scale-105 transition">
      <i class="fa-solid fa-user text-teal-700 dark:text-teal-300" aria-hidden="true"></i>
    </button>
  </header>
  <!-- KPIs -->
  <section class="grid grid-cols-1 md:grid-cols-4 gap-4 p-6">
    <div class="card p-5">
      <p class="text-gray-500 dark:text-gray-300">Registros</p>
      <h2 class="text-3xl font-bold" id="totalRegistros">0</h2>
    </div>
    <div class="card p-5">
      <p class="text-gray-500 dark:text-gray-300">Fichados</p>
      <h2 class="text-3xl font-bold text-green-600" id="fichados">0</h2>
    </div>
    <div class="card p-5">
      <p class="text-gray-500 dark:text-gray-300">No fichados</p>
      <h2 class="text-3xl font-bold text-red-600" id="noFichados">0</h2>
    </div>
    <div class="card p-5">
      <p class="text-gray-500 dark:text-gray-300">Empleados únicos</p>
      <h2 class="text-3xl font-bold" id="empleadosUnicos">0</h2>
    </div>
  </section>
  <!-- FILTROS -->
  <section class="card mx-6 p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">Filtros</h2>
    <div class="flex flex-wrap gap-4">
      <label for="filtroNombre" class="sr-only">Filtrar por empleado</label>
      <input id="filtroNombre" type="text" placeholder="Empleado" class="border px-3 py-2 rounded-lg text-sm">
      <label for="fechaInicio" class="sr-only">Fecha inicio</label>
      <input id="fechaInicio" type="date" class="border px-3 py-2 rounded-lg text-sm">
      <label for="fechaFin" class="sr-only">Fecha fin</label>
      <input id="fechaFin" type="date" class="border px-3 py-2 rounded-lg text-sm">
    </div>
  </section>

  <!-- TABLA -->
  <section class="card mx-6 p-6 mb-6">
    <h2 class="text-xl font-bold mb-4">Resultados</h2>
    <table class="w-full text-sm">
      <thead class="text-left">
        <tr>
          <th class="p-3">Nombre</th>
          <th>Fecha</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody id="tablaResultados"></tbody>
    </table>
  </section>

  <!-- GRÁFICOS -->
  <section class="grid grid-cols-1 md:grid-cols-2 gap-6 p-6">
    <div class="card p-6 chart-card">
      <h3 class="font-bold mb-4">Fichajes (Barras)</h3>
      <canvas id="barChart"></canvas>
    </div>
    <div class="card p-6 chart-card">
      <h3 class="font-bold mb-4">Fichajes (Tarta)</h3>
      <canvas id="pieChart"></canvas>
    </div>
  </section>

  <script>
    /* ===== DATOS ===== */
    const DATA_URL = "../data/fichajes.json";
    const LOCAL_RRHH_KEY = "fichajes-empleados";
    let registros = [];

    const tabla = document.getElementById("tablaResultados");

    function nombreDesdeCorreo(correo) {
      if (!correo) return "Empleado";
      const base = correo.split("@")[0] || "";
      if (!base) return "Empleado";
      return base.charAt(0).toUpperCase() + base.slice(1);
    }

    function cargarDatosLocal() {
      try {
        const raw = localStorage.getItem(LOCAL_RRHH_KEY);
        return raw ? JSON.parse(raw) : {};
      } catch (error) {
        console.warn("No se pudieron leer los datos locales:", error);
        return {};
      }
    }

    function mergeDatos(base, local) {
      const merged = { empleados: {} };
      const baseEmpleados = base && base.empleados ? base.empleados : {};

      Object.keys(baseEmpleados).forEach(correo => {
        const info = baseEmpleados[correo] || {};
        merged.empleados[correo] = {
          nombre: info.nombre || nombreDesdeCorreo(correo),
          registros: { ...(info.registros || {}) }
        };
      });

      if (local && typeof local === "object") {
        Object.keys(local).forEach(correo => {
          const info = local[correo] || {};
          if (!merged.empleados[correo]) {
            merged.empleados[correo] = {
              nombre: info.nombre || nombreDesdeCorreo(correo),
              registros: {}
            };
          }
          const registrosBase = merged.empleados[correo].registros || {};
          const registrosLocal = info.registros || {};
          merged.empleados[correo].registros = { ...registrosBase, ...registrosLocal };
          if (!merged.empleados[correo].nombre) {
            merged.empleados[correo].nombre = info.nombre || nombreDesdeCorreo(correo);
          }
        });
      }

      return merged;
    }

    async function cargarDatos() {
      let base = { empleados: {} };
      try {
        const resp = await fetch(DATA_URL, { cache: "no-store" });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        base = await resp.json();
      } catch (error) {
        console.warn("No se pudieron cargar los datos base:", error);
      }
      return mergeDatos(base, cargarDatosLocal());
    }

    function construirRegistros(empleados) {
      const lista = [];
      if (!empleados || typeof empleados !== "object") return lista;

      Object.keys(empleados).forEach(correo => {
        const info = empleados[correo] || {};
        const nombre = info.nombre || nombreDesdeCorreo(correo);
        const registrosEmpleado = info.registros || {};
        Object.keys(registrosEmpleado).forEach(fecha => {
          const registro = registrosEmpleado[fecha] || {};
          const fichado = !!(registro.entrada && registro.entrada !== "--:--");
          lista.push({ nombre, fecha, fichado });
        });
      });

      return lista.sort((a, b) => a.fecha.localeCompare(b.fecha));
    }

    async function cargarRegistros() {
      const data = await cargarDatos();
      registros = construirRegistros(data.empleados || {});
    }

    function renderTabla(data) {
      tabla.innerHTML = "";
      data.forEach(r => {
        tabla.innerHTML += `
          <tr class="border-b dark:border-gray-600">
            <td class="p-3 font-medium">${r.nombre}</td>
            <td>${r.fecha}</td>
            <td>
              <span class="px-3 py-1 rounded-full text-xs font-bold
                ${r.fichado ? 'bg-green-100' : 'bg-red-100'}">
                ${r.fichado ? 'Fichado' : 'No fichado'}
              </span>
            </td>
          </tr>
        `;
      });
    }

    function actualizarDashboard(data) {
      const fichados = data.filter(d => d.fichado).length;
      const noFichados = data.length - fichados;
      const empleadosUnicos = new Set(data.map(d => d.nombre)).size;

      document.getElementById("totalRegistros").textContent = data.length;
      document.getElementById("fichados").textContent = fichados;
      document.getElementById("noFichados").textContent = noFichados;
      document.getElementById("empleadosUnicos").textContent = empleadosUnicos;

      barChart.data.datasets[0].data = [fichados, noFichados];
      pieChart.data.datasets[0].data = [fichados, noFichados];
      barChart.update();
      pieChart.update();
    }

    function aplicarFiltros() {
      const nombre = document.getElementById("filtroNombre").value.toLowerCase();
      const inicio = document.getElementById("fechaInicio").value;
      const fin = document.getElementById("fechaFin").value;

      const filtrados = registros.filter(r => {
        const okNombre = r.nombre.toLowerCase().includes(nombre);
        const okInicio = !inicio || r.fecha >= inicio;
        const okFin = !fin || r.fecha <= fin;
        return okNombre && okInicio && okFin;
      });

      renderTabla(filtrados);
      actualizarDashboard(filtrados);
    }

    document.querySelectorAll("#filtroNombre, #fechaInicio, #fechaFin")
      .forEach(el => el.addEventListener("input", aplicarFiltros));

    /* ===== GRÁFICOS ===== */
    const barChart = new Chart(document.getElementById("barChart"), {
      type: "bar",
      data: { labels: ["Fichados", "No fichados"], datasets: [{ data: [0, 0], backgroundColor: ["#16a34a", "#dc2626"] }] },
      options: { responsive: true, maintainAspectRatio: false }
    });

    const pieChart = new Chart(document.getElementById("pieChart"), {
      type: "pie",
      data: { labels: ["Fichados", "No fichados"], datasets: [{ data: [0, 0], backgroundColor: ["#22c55e", "#ef4444"] }] },
      options: { responsive: true, maintainAspectRatio: false }
    });

    async function refrescarDatos() {
      await cargarRegistros();
      aplicarFiltros();
    }

    window.addEventListener("storage", (event) => {
      if (event.key === LOCAL_RRHH_KEY) {
        refrescarDatos();
      }
    });

    refrescarDatos();
  </script>
</body>
</html>

