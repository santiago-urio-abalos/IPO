<!DOCTYPE html>
<html lang="es">

<head>
    <script>
        (function () {
            try {
                if (localStorage.getItem("darkMode") === "enabled") {
                    document.documentElement.classList.add("dark");
                }
            } catch (e) {}
        })();
    </script>

    <link rel="stylesheet" href="../css/dark-mode.css">
    <!-- Font Awesome 6 -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
        crossorigin="anonymous" />

    <meta charset="UTF-8" />
    <title>Usuario</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        .slider-track {
            position: relative;
            height: 54px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            padding: 0 12px;
            overflow: hidden;
            cursor: grab;
            transition: opacity 0.3s ease, background-color 0.3s ease;
        }

        .slider-thumb {
            position: absolute;
            height: 44px;
            width: 44px;
            border-radius: 9999px;
            background: #1f0f0f;
            top: 5px;
            left: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            transition: left 0.1s linear;
            user-select: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.25);
        }

        .slider-track.disabled {
            opacity: 0.45;
            cursor: not-allowed !important;
        }

        .icon-btn {
            background: none;
            border: none;
            cursor: pointer;
        }

        .icon-img {
            width: 34px;
            height: 34px;
            border-radius: 50%;
        }
        .estado-valor {
            color: #111827;
            font-weight: 600;
        }
        html.dark .estado-valor {
            color: #f9fafb;
        }
        button {
            background-color: var(--btn-bg);
            color: var(--btn-text);
        }

        /* ===== DARK MODE SUPPORT (SOLO VISUAL) ===== */

/* Fondo general */
html.dark body {
    background-color: #111827;
}

/* Contenedor principal */
html.dark .max-w-xl {
    background-color: #111827;
}

/* Cards / cajas blancas */
html.dark .bg-white {
    background-color: #1f2937 !important;
}

/* Textos */
html.dark .text-gray-500 {
    color: #9ca3af !important;
}

/* Modal */
html.dark #confirmModal > div {
    background-color: #1f2937;
    color: #ffffff;
}

/* Iconos PNG negros → blancos */
html.dark img.icon-img {
    filter: invert(1) brightness(1.2);
}
html.dark {
    color-scheme: dark;
    --btn-bg: #374151;   /* gris oscuro */
    --btn-text: #f9fafb; /* blanco */
}

    </style>
</head>

<body class="bg-[#F4F7FB] min-h-screen">

<!-- CONTENEDOR PRINCIPAL -->
<div class="max-w-xl mx-auto min-h-screen bg-[#F4F7FB]">


    <!-- Header -->
    <div class="p-6 flex justify-between items-center">
        <h1 class="text-2xl font-bold">Hola, Usuario</h1>

        <button class="icon-btn" aria-label="perfil de usuario" onclick="window.location.href='../features/settings.html'">
            <i class="fa-solid fa-user text-2xl"></i>
        </button>
    </div>

    <!-- Hora -->
    <div class="px-6">
        <div class="p-10 bg-blue-600 rounded-2xl text-white text-center shadow">
            <h2 class="font-bold text-lg">Hora actual</h2>
            <p id="time" class="text-4xl font-bold mt-2"></p>
            <p id="date" class="mt-2"></p>
        </div>
    </div>

    <!-- ESTADO -->
    <div class="px-6 mt-6">
        <div class="bg-white p-5 rounded-2xl shadow">
            <h3 class="font-bold text-lg">Estado actual</h3>
            <div class="mt-3 space-y-1 text-sm">
                <p><span class="text-gray-500">Jornada:</span> <span id="estadoJornada" class="estado-valor">No iniciada</span></p>
                <p><span class="text-gray-500">Pausa:</span> <span id="estadoPausa" class="estado-valor">Sin pausa</span></p>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm mt-4">
                <div>
                    <p class="text-gray-500">Entrada</p>
                    <p id="horaEntrada" class="estado-valor">--:--</p>
                </div>
                <div>
                    <p class="text-gray-500">Salida</p>
                    <p id="horaSalida" class="estado-valor">--:--</p>
                </div>
                <div>
                    <p class="text-gray-500">Inicio pausa</p>
                    <p id="horaPausaInicio" class="estado-valor">--:--</p>
                </div>
                <div>
                    <p class="text-gray-500">Fin pausa</p>
                    <p id="horaPausaFin" class="estado-valor">--:--</p>
                </div>
            </div>
            <p class="text-xs text-gray-500 mt-3">Ultima accion: <span id="ultimaAccion">--</span></p>
        </div>
    </div>

    <!-- SLIDER JORNADA -->
    <div class="px-6 mt-6">
        <div id="sliderJornada" class="slider-track text-white shadow"
            style="background-color:#15803D;">
            <div id="thumbJornada" class="slider-thumb">➜</div>
            <span id="labelJornada" class="mx-auto font-medium">
                Desliza para iniciar jornada
            </span>
        </div>
    </div>

    <!-- SLIDER PAUSA -->
    <div class="px-6 mt-4">
        <div id="sliderPausa" class="slider-track text-white shadow disabled"
            style="background-color:#ce3d1c;">
            <div id="thumbPausa" class="slider-thumb">➜</div>
            <span id="labelPausa" class="mx-auto font-medium">
                Desliza para iniciar pausa
            </span>
        </div>
    </div>

    <!-- Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center">
        <div class="bg-white w-80 p-6 rounded-xl shadow text-center">
            <p id="modalMessage" class="text-lg font-semibold mb-4">¿Confirmar acción?</p>
            <div class="flex gap-4 justify-center">
                <button id="btnNo" class="px-4 py-2 bg-red-700 text-white rounded-lg">No</button>
                <button id="btnSi" class="px-4 py-2 bg-green-700 text-white rounded-lg">Sí</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div class="px-6 mt-6 grid grid-cols-1 gap-4 pb-8">

        <div class="bg-white p-6 rounded-2xl shadow flex items-center gap-4 cursor-pointer hover:shadow-lg transition"
            onclick="window.location.href='../features/resumen.html'">
            <i class="fa-solid fa-clock text-blue-600 text-3xl"></i>
            <div>
                <h3 class="font-bold text-lg">Resumen del día</h3>
                <p class="text-gray-500 text-sm">Ver jornada completa</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow flex items-center gap-4 cursor-pointer hover:shadow-lg transition"
            onclick="window.location.href='../features/semana.html'">
            <i class="fa-solid fa-calendar-week text-green-600 text-3xl"></i>
            <div>
                <h3 class="font-bold text-lg">Semana</h3>
                <p class="text-gray-500 text-sm">Gráfico semanal</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow flex items-center gap-4 cursor-pointer hover:shadow-lg transition"
            onclick="window.location.href='../features/calendario.html'">
            <i class="fa-solid fa-calendar-days text-purple-600 text-3xl"></i>
            <div>
                <h3 class="font-bold text-lg">Calendario</h3>
                <p class="text-gray-500 text-sm">Vista mensual</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow flex items-center gap-4 cursor-pointer hover:shadow-lg transition"
            onclick="window.location.href='../features/incidencias.html'">
            <i class="fa-solid fa-triangle-exclamation text-red-600 text-3xl"></i>
            <div>
                <h3 class="font-bold text-lg">Incidencias</h3>
                <p class="text-gray-500 text-sm">Crear o revisar</p>
            </div>
        </div>

    </div>
    <!-- TOAST NOTIFICACIÓN -->
    <div id="toast"
        style="display:none"
        class="fixed bottom-6 right-6 bg-green-700 text-white px-5 py-3 rounded-xl shadow-xl flex items-center gap-3 z-[9999]">
        <i class="fa-solid fa-check-circle text-xl"></i>
        <span id="toastMessage">Acción registrada correctamente</span>
    </div>


</div>

<!-- JS ORIGINAL (sin cambios) -->
<script>
    function updateClock() {
        const now = new Date();
        document.getElementById("time").textContent =
            now.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });
        document.getElementById("date").textContent =
            now.toLocaleDateString("es-ES", { weekday: 'long', day: 'numeric', month: 'long' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    let jornadaIniciada = false;
    let pausaIniciada = false;
    let activeSlider = null;

    const RESUMEN_DIA_KEY = "resumen-dia-events";
    const FICHAJES_DIARIOS_KEY = "fichajes-diarios";
    const etiquetasAccion = {
        entrada: "Entrada",
        salida: "Salida",
        pausa: "Inicio pausa",
        finPausa: "Fin pausa"
    };

    function padNumero(valor) {
        return valor.toString().padStart(2, "0");
    }

    function toDateKey(date = new Date()) {
        return `${date.getFullYear()}-${padNumero(date.getMonth() + 1)}-${padNumero(date.getDate())}`;
    }

    function cargarStoreDiario() {
        try {
            const raw = localStorage.getItem(FICHAJES_DIARIOS_KEY);
            return raw ? JSON.parse(raw) : {};
        } catch (error) {
            console.warn("No se pudo leer el store diario", error);
            return {};
        }
    }

    function guardarStoreDiario(store) {
        try {
            localStorage.setItem(FICHAJES_DIARIOS_KEY, JSON.stringify(store));
        } catch (error) {
            console.warn("No se pudo guardar el store diario", error);
        }
    }

    function eventosSonDelDia(eventos, dateKey) {
        if (!Array.isArray(eventos)) return false;
        return eventos.every(ev => {
            if (!ev || !ev.time) return false;
            return toDateKey(new Date(ev.time)) === dateKey;
        });
    }

    function cargarEventosHoy() {
        const hoyKey = toDateKey(new Date());
        const store = cargarStoreDiario();
        const guardados = store[hoyKey];
        if (Array.isArray(guardados) && eventosSonDelDia(guardados, hoyKey)) {
            return guardados;
        }

        try {
            const raw = localStorage.getItem(RESUMEN_DIA_KEY);
            if (raw) {
                const parsed = JSON.parse(raw);
                if (Array.isArray(parsed) && eventosSonDelDia(parsed, hoyKey)) {
                    store[hoyKey] = parsed;
                    guardarStoreDiario(store);
                    return parsed;
                }
            }
        } catch (error) {
            console.warn("No se pudieron cargar eventos previos", error);
        }

        return [];
    }

    function guardarEventos(eventos, date = new Date()) {
        const dateKey = toDateKey(date);
        const store = cargarStoreDiario();
        store[dateKey] = eventos;
        guardarStoreDiario(store);

        const hoyKey = toDateKey(new Date());
        if (dateKey === hoyKey) {
            try {
                localStorage.setItem(RESUMEN_DIA_KEY, JSON.stringify(eventos));
            } catch (error) {
                console.warn("No se pudieron guardar eventos del dia", error);
            }
        }
    }

    let eventosHoy = cargarEventosHoy();

    const RRHH_STORAGE_KEY = "fichajes-empleados";

    function nombreDesdeEmail(email) {
        if (!email) return "Usuario";
        const base = email.split("@")[0] || "";
        if (!base) return "Usuario";
        return base.charAt(0).toUpperCase() + base.slice(1);
    }

    const userEmail = (localStorage.getItem("userEmail") || "usuario@click.com").toLowerCase();
    const userNombre = nombreDesdeEmail(userEmail);
    if (!localStorage.getItem("userEmail")) {
        localStorage.setItem("userEmail", userEmail);
    }

    function cargarStoreRRHH() {
        try {
            const raw = localStorage.getItem(RRHH_STORAGE_KEY);
            return raw ? JSON.parse(raw) : {};
        } catch (error) {
            console.warn("No se pudo leer el store RRHH", error);
            return {};
        }
    }

    function guardarStoreRRHH(store) {
        try {
            localStorage.setItem(RRHH_STORAGE_KEY, JSON.stringify(store));
        } catch (error) {
            console.warn("No se pudo guardar el store RRHH", error);
        }
    }

    function formatMinutos(minutos) {
        const horas = Math.floor(minutos / 60);
        const mins = minutos % 60;
        return `${padNumero(horas)}:${padNumero(mins)}`;
    }

    function calcularPausaMinutos(eventos, dateKey) {
        let pausaMs = 0;
        let pausaStart = null;
        const hoyKey = toDateKey(new Date());

        eventos.forEach(ev => {
            const time = new Date(ev.time);
            if (ev.type === "pausa") {
                pausaStart = time;
            }
            if (ev.type === "finPausa" && pausaStart) {
                pausaMs += time - pausaStart;
                pausaStart = null;
            }
        });

        if (pausaStart) {
            const fin = dateKey === hoyKey ? new Date() : new Date(eventos[eventos.length - 1].time);
            pausaMs += fin - pausaStart;
        }

        const minutos = Math.max(0, Math.floor(pausaMs / 60000));
        return minutos;
    }

    function construirRegistroDiario(eventos, dateKey) {
        if (!Array.isArray(eventos) || eventos.length === 0) return null;

        const ordenados = [...eventos].sort((a, b) => new Date(a.time) - new Date(b.time));
        const entradaEv = ordenados.find(ev => ev.type === "entrada");
        if (!entradaEv) return null;

        const salidaEv = [...ordenados].reverse().find(ev => ev.type === "salida");
        const pausaMin = calcularPausaMinutos(ordenados, dateKey);

        return {
            entrada: formatHora(new Date(entradaEv.time)),
            salida: salidaEv ? formatHora(new Date(salidaEv.time)) : "",
            pausas: formatMinutos(pausaMin)
        };
    }

    function actualizarRegistroRRHH(eventos, date = new Date()) {
        if (!userEmail) return;
        const dateKey = toDateKey(date);
        const registro = construirRegistroDiario(eventos, dateKey);
        if (!registro) return;

        const store = cargarStoreRRHH();
        if (!store[userEmail]) {
            store[userEmail] = { nombre: userNombre, registros: {} };
        }
        if (!store[userEmail].nombre) {
            store[userEmail].nombre = userNombre;
        }
        if (!store[userEmail].registros) {
            store[userEmail].registros = {};
        }
        store[userEmail].registros[dateKey] = registro;
        guardarStoreRRHH(store);
    }

    const estadoUI = {
        jornada: document.getElementById("estadoJornada"),
        pausa: document.getElementById("estadoPausa"),
        entrada: document.getElementById("horaEntrada"),
        salida: document.getElementById("horaSalida"),
        pausaInicio: document.getElementById("horaPausaInicio"),
        pausaFin: document.getElementById("horaPausaFin"),
        ultimaAccion: document.getElementById("ultimaAccion")
    };

    function formatHora(date) {
        return date.toLocaleTimeString("es-ES", { hour: "2-digit", minute: "2-digit" });
    }

    function actualizarEstado() {
        if (!estadoUI.jornada || !estadoUI.pausa) return;

        if (jornadaIniciada) {
            estadoUI.jornada.textContent = "En curso";
        } else if (estadoUI.entrada.textContent !== "--:--") {
            estadoUI.jornada.textContent = "Finalizada";
        } else {
            estadoUI.jornada.textContent = "No iniciada";
        }

        estadoUI.pausa.textContent = pausaIniciada ? "En pausa" : "Sin pausa";
    }

    function registrarAccion(tipo, date = new Date()) {
        if (!estadoUI.ultimaAccion) return;

        const hora = formatHora(date);

        if (tipo === "entrada") estadoUI.entrada.textContent = hora;
        if (tipo === "salida") estadoUI.salida.textContent = hora;
        if (tipo === "pausa") estadoUI.pausaInicio.textContent = hora;
        if (tipo === "finPausa") estadoUI.pausaFin.textContent = hora;

        const etiqueta = etiquetasAccion[tipo] || "Accion";

        estadoUI.ultimaAccion.textContent = `${etiqueta} ${hora}`;
        actualizarEstado();

        const evento = { type: tipo, time: date.toISOString() };
        eventosHoy.push(evento);
        guardarEventos(eventosHoy, date);
        actualizarRegistroRRHH(eventosHoy, date);
    }

    const sliders = {
        jornada: {
            track: document.getElementById("sliderJornada"),
            thumb: document.getElementById("thumbJornada"),
            label: document.getElementById("labelJornada"),
        },
        pausa: {
            track: document.getElementById("sliderPausa"),
            thumb: document.getElementById("thumbPausa"),
            label: document.getElementById("labelPausa"),
        }
    };

    function syncSliders() {
        sliders.jornada.label.textContent =
            jornadaIniciada ? "Desliza para finalizar jornada" : "Desliza para iniciar jornada";
        sliders.jornada.track.style.backgroundColor =
            jornadaIniciada ? "#116931" : "#15803D";
        sliders.pausa.label.textContent =
            pausaIniciada ? "Desliza para terminar pausa" : "Desliza para iniciar pausa";
        sliders.pausa.track.style.backgroundColor =
            pausaIniciada ? "#a13017" : "#ce3d1c";
        sliders.pausa.track.classList.toggle("disabled", !jornadaIniciada);
        sliders.jornada.track.classList.toggle("disabled", pausaIniciada);
    }

    function syncEstadoDesdeEventos(eventos) {
        if (!Array.isArray(eventos) || eventos.length === 0) return;

        const ordenados = [...eventos].sort((a, b) => new Date(a.time) - new Date(b.time));
        const ultimaEntrada = [...ordenados].reverse().find(ev => ev.type === "entrada");
        const ultimaSalida = [...ordenados].reverse().find(ev => ev.type === "salida");
        const ultimaPausa = [...ordenados].reverse().find(ev => ev.type === "pausa");
        const ultimaFinPausa = [...ordenados].reverse().find(ev => ev.type === "finPausa");

        jornadaIniciada = !!(ultimaEntrada && (!ultimaSalida || new Date(ultimaEntrada.time) > new Date(ultimaSalida.time)));
        pausaIniciada = !!(ultimaPausa && (!ultimaFinPausa || new Date(ultimaPausa.time) > new Date(ultimaFinPausa.time)));

        if (ultimaEntrada) estadoUI.entrada.textContent = formatHora(new Date(ultimaEntrada.time));
        if (ultimaSalida) estadoUI.salida.textContent = formatHora(new Date(ultimaSalida.time));
        if (ultimaPausa) estadoUI.pausaInicio.textContent = formatHora(new Date(ultimaPausa.time));
        if (ultimaFinPausa) estadoUI.pausaFin.textContent = formatHora(new Date(ultimaFinPausa.time));

        const ultimoEvento = ordenados[ordenados.length - 1];
        if (ultimoEvento && estadoUI.ultimaAccion) {
            const etiqueta = etiquetasAccion[ultimoEvento.type] || "Accion";
            estadoUI.ultimaAccion.textContent = `${etiqueta} ${formatHora(new Date(ultimoEvento.time))}`;
        }

        syncSliders();
        actualizarEstado();
        actualizarRegistroRRHH(ordenados, new Date(ordenados[0].time));
    }

    function setupSlider(key) {
        const s = sliders[key];
        let dragging = false;
        let startX = 0;

        s.track.addEventListener("mousedown", (e) => {
            if (s.track.classList.contains("disabled")) return;
            dragging = true;
            startX = e.clientX;
        });

        document.addEventListener("mousemove", (e) => {
            if (!dragging) return;
            let delta = e.clientX - startX;
            let max = s.track.offsetWidth - 54;
            delta = Math.max(0, Math.min(delta, max));
            s.thumb.style.left = delta + "px";
        });

        document.addEventListener("mouseup", () => {
            if (!dragging) return;
            dragging = false;
            let max = s.track.offsetWidth - 54;
            if (parseInt(s.thumb.style.left) >= max - 5) {
                activeSlider = key;
                openConfirm(key);
            }
            s.thumb.style.left = "5px";
        });
    }

    setupSlider("jornada");
    setupSlider("pausa");
    if (eventosHoy.length) {
        syncEstadoDesdeEventos(eventosHoy);
    } else {
        syncSliders();
        actualizarEstado();
    }

    const modal = document.getElementById("confirmModal");
    const modalMessage = document.getElementById("modalMessage");

    function openConfirm(key) {
        modalMessage.textContent =
            key === "jornada"
                ? (jornadaIniciada ? "¿Desea terminar la jornada?" : "¿Desea iniciar la jornada?")
                : (pausaIniciada ? "¿Desea terminar la pausa?" : "¿Desea iniciar la pausa?");
        modal.classList.remove("hidden");
    }

    document.getElementById("btnNo").onclick = () => {
        modal.classList.add("hidden");
        activeSlider = null;
    };

    document.getElementById("btnSi").onclick = () => {
        if (activeSlider === "jornada") {
            jornadaIniciada = !jornadaIniciada;
            sliders.jornada.label.textContent =
                jornadaIniciada ? "Desliza para finalizar jornada" : "Desliza para iniciar jornada";
            sliders.jornada.track.style.backgroundColor =
                jornadaIniciada ? "#116931" : "#15803D";
            sliders.pausa.track.classList.toggle("disabled", !jornadaIniciada);
            if (jornadaIniciada) {
                registrarAccion("entrada");
            } else {
                registrarAccion("salida");
            }
        }

        if (activeSlider === "pausa") {
            pausaIniciada = !pausaIniciada;
            sliders.pausa.label.textContent =
                pausaIniciada ? "Desliza para terminar pausa" : "Desliza para iniciar pausa";
            sliders.pausa.track.style.backgroundColor =
                pausaIniciada ? "#a13017" : "#ce3d1c";
            sliders.jornada.track.classList.toggle("disabled", pausaIniciada);
            if (pausaIniciada) {
                registrarAccion("pausa");
            } else {
                registrarAccion("finPausa");
            }
        }
        const accion = activeSlider; // ← GUARDAMOS LA ACCIÓN

        modal.classList.add("hidden");
        activeSlider = null;

        if (accion === "jornada") {
            showToast(
                jornadaIniciada
                    ? "Jornada iniciada correctamente"
                    : "Jornada finalizada correctamente"
            );
        }

        if (accion === "pausa") {
            showToast(
                pausaIniciada
                    ? "Pausa iniciada correctamente"
                    : "Pausa finalizada correctamente"
            );
        }


    };

</script>
<script>
    const toast = document.getElementById("toast");
    const toastMessage = document.getElementById("toastMessage");
    let toastTimeout;

    function showToast(message) {
        console.log("Toast mostrado:", message); // DEBUG
        toastMessage.textContent = message;
        toast.style.display = "flex";

        clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
            toast.style.display = "none";
        }, 3000);
    }
</script>
<script src="../js/dark-mode.js" type="module"></script>

</body>
</html>
