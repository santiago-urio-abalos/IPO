<!DOCTYPE html>
<html lang="es">
<head>
    <link rel="stylesheet" href="../css/dark-theme.css">
    <title>Consultar fichajes</title>

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #f4f4f4;
        }

        header {
            background: #003366;
            padding: 15px;
            color: white;
            text-align: center;
            font-size: 22px;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 30px auto;
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 0 10px #cccccc;
        }

        /* BUSCADOR */
.search-box {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
}

.search-box input {
    width: 400px; /* ancho fijo o máximo deseado */
    max-width: 90%; /* responsive */
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ccc;
    font-size: 16px;
}


        .search-box button {
            background: #003366;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }

        /* OPCIONES */
        .mode-box {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }

        .mode-box label {
            font-weight: bold;
            margin-right: 20px;
            cursor: pointer;
        }

        /* CALENDARIOS */
        .calendar-container {
            display: none;
            gap: 20px;
            margin-top: 20px;
        }

        .calendar-container.active {
            display: flex;
        }

        .calendar-container div {
            display: flex;
            flex-direction: column;
        }

        .calendar-container input {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        /* TABLA */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
        }

        table th, table td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }

        table th {
            background: #003366;
            color: white;
        }

        .no-data {
            text-align: center;
            color: #4f4f4f;
            margin-top: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>

    <header role="heading" aria-level="1" style="position: relative;">
    <a href="../pages/rrhh.html" style="
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 24px;
        color: white;
        text-decoration: none;
    " aria-label="Volver al panel de control">&#8592;</a>
    CONSULTAR DATOS DE FICHAJE
</header>

<div class="container">

    <!-- BUSCADOR -->
    <div class="search-box">
    <label for="correo" style="display:flex; align-items:center; font-weight:bold; margin-right:10px;">
        Correo del empleado:
    </label>
    <input type="email" id="correo" placeholder="Introduce el correo del empleado..." aria-label="Correo del empleado">
    <button onclick="consultar()" aria-label="Consultar fichajes del empleado">Consultar</button>
</div>


    <!-- MODO 1 DÍA / 2 DÍAS -->
    <fieldset class="mode-box">
        <legend>Selecciona tipo de consulta</legend>

        <label for="mode1">
            <input type="radio" id="mode1" name="mode" value="1" checked onclick="cambiarModo()"> 
            Consultar 1 día
        </label>

        <label for="mode2">
            <input type="radio" id="mode2" name="mode" value="2" onclick="cambiarModo()"> 
            Consultar varios días
        </label>
    </fieldset>

    <!-- CALENDARIO MODO 1 DÍA -->
    <div id="cal1" class="calendar-container active">
        <div>
            <label for="dia_unico">Día:</label>
            <input type="date" id="dia_unico">
        </div>
    </div>

    <!-- CALENDARIO MODO 2 DÍAS -->
    <div id="cal2" class="calendar-container">
        <div>
            <label for="dia1">Desde:</label>
            <input type="date" id="dia1">
        </div>

        <div>
            <label for="dia2">Hasta:</label>
            <input type="date" id="dia2">
        </div>
    </div>

    <!-- TABLA -->
    <table id="tablaFichajes" style="display:none;" aria-label="Tabla de fichajes del empleado seleccionado">
        <thead>
            <tr>
                <th scope="col">Día</th>
                <th scope="col">Hora de Entrada</th>
                <th scope="col">Hora de Salida</th>
                <th scope="col">Pausas</th>
                <th scope="col">Total Horas</th>
            </tr>
        </thead>
        <tbody id="tablaBody"></tbody>
    </table>

    <p id="noData" class="no-data">Introduce un correo y selecciona la fecha o fechas.</p>

</div>

<script>
    /* DATOS DESDE JSON */
    const DATA_URL = "../data/fichajes.json";
    const LOCAL_RRHH_KEY = "fichajes-empleados";
    let datosFichajes = null;
    let datosError = false;

    function nombreDesdeCorreo(correo) {
        if (!correo) return "Empleado";
        const base = correo.split("@")[0] || "";
        if (!base) return "Empleado";
        return base.charAt(0).toUpperCase() + base.slice(1);
    }

    function cargarDatosLocal() {
        try {
            const raw = localStorage.getItem(LOCAL_RRHH_KEY);
            return raw ? JSON.parse(raw) : {};
        } catch (error) {
            console.warn("No se pudieron leer los datos locales:", error);
            return {};
        }
    }

    function mergeDatos(base, local) {
        const merged = { empleados: {} };
        const baseEmpleados = base && base.empleados ? base.empleados : {};

        Object.keys(baseEmpleados).forEach(correo => {
            const info = baseEmpleados[correo] || {};
            merged.empleados[correo] = {
                nombre: info.nombre || nombreDesdeCorreo(correo),
                registros: { ...(info.registros || {}) }
            };
        });

        if (local && typeof local === "object") {
            Object.keys(local).forEach(correo => {
                const info = local[correo] || {};
                if (!merged.empleados[correo]) {
                    merged.empleados[correo] = {
                        nombre: info.nombre || nombreDesdeCorreo(correo),
                        registros: {}
                    };
                }
                const registrosBase = merged.empleados[correo].registros || {};
                const registrosLocal = info.registros || {};
                merged.empleados[correo].registros = { ...registrosBase, ...registrosLocal };
                if (!merged.empleados[correo].nombre) {
                    merged.empleados[correo].nombre = info.nombre || nombreDesdeCorreo(correo);
                }
            });
        }

        return merged;
    }

    async function cargarDatos() {
        if (datosFichajes || datosError) return datosFichajes;
        let base = { empleados: {} };
        try {
            const resp = await fetch(DATA_URL, { cache: "no-store" });
            if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
            base = await resp.json();
        } catch (error) {
            console.error("No se pudieron cargar los datos:", error);
            datosError = true;
        }
        datosFichajes = mergeDatos(base, cargarDatosLocal());
        return datosFichajes;
    }

    function cambiarModo() {
        const modo = document.querySelector('input[name="mode"]:checked').value;

        document.getElementById("cal1").classList.remove("active");
        document.getElementById("cal2").classList.remove("active");

        if (modo === "1") {
            document.getElementById("cal1").classList.add("active");
        } else {
            document.getElementById("cal2").classList.add("active");
        }
    }

    async function consultar() {
        const correo = document.getElementById("correo").value.trim().toLowerCase();
        const modo = document.querySelector('input[name="mode"]:checked').value;

        if (!correo) {
            alert("Introduce un correo válido.");
            return;
        }

        const dataBase = await cargarDatos();
        const data = mergeDatos(dataBase || { empleados: {} }, cargarDatosLocal());

        if (!data || !data.empleados) {
            mostrarMensaje("No se pudo cargar la base de datos.");
            return;
        }

        const empleado = data.empleados[correo];

        if (!empleado) {
            mostrarMensaje("No se encontraron datos para ese correo.");
            return;
        }

        const tablaBody = document.getElementById("tablaBody");
        tablaBody.innerHTML = "";

        const registros = empleado.registros || {};

        if (modo === "1") consultarUnDia(registros);
        else consultarDosDias(registros);
    }

    function consultarUnDia(registros) {
        const dia = document.getElementById("dia_unico").value;

        if (!dia) {
            alert("Selecciona un día.");
            return;
        }

        agregarFila(registros, dia);
    }

    function consultarDosDias(registros) {
    const d1 = document.getElementById("dia1").value;
    const d2 = document.getElementById("dia2").value;

    if (!d1 || !d2) {
        alert("Selecciona ambos días.");
        return;
    }

    if (d1 > d2) {
        alert("La fecha inicial no puede ser mayor que la final.");
        return;
    }

    listarRangoFechas(registros, d1, d2);
}

/* NUEVA FUNCIÓN: RECORRE TODAS LAS FECHAS DEL RANGO */
function listarRangoFechas(registros, fechaInicio, fechaFin) {
    const tablaBody = document.getElementById("tablaBody");
    tablaBody.innerHTML = "";

    let actual = new Date(fechaInicio);
    const fin = new Date(fechaFin);

    while (actual <= fin) {
        const dia = actual.toISOString().split("T")[0]; // YYYY-MM-DD
        agregarFila(registros, dia);

        // avanzar un día
        actual.setDate(actual.getDate() + 1);
    }

    document.getElementById("tablaFichajes").style.display = "table";
    document.getElementById("noData").style.display = "none";
}


    function agregarFila(registros, dia) {
        const tablaBody = document.getElementById("tablaBody");

        if (registros[dia]) {
            const r = registros[dia];
            const entrada = r.entrada || "--:--";
            const salida = r.salida || "--:--";
            const pausas = r.pausas || "00:00";
            const totalHoras = calcularHoras(entrada, salida, pausas);

            tablaBody.innerHTML += `
                <tr>
                    <td>${dia}</td>
                    <td>${entrada}</td>
                    <td>${salida}</td>
                    <td>${pausas}</td>
                    <td>${totalHoras}</td>
                </tr>`;
        } else {
            tablaBody.innerHTML += `
                <tr>
                    <td>${dia}</td>
                    <td colspan="4">No hay fichaje este día</td>
                </tr>`;
        }

        document.getElementById("tablaFichajes").style.display = "table";
        document.getElementById("noData").style.display = "none";
    }

    function parseHora(valor) {
        if (!valor || typeof valor !== "string") return null;
        const partes = valor.split(":").map(Number);
        if (partes.length !== 2 || partes.some(Number.isNaN)) return null;
        return partes;
    }

    function calcularHoras(entrada, salida, pausas) {
        const inicio = parseHora(entrada);
        const fin = parseHora(salida);
        const pausa = parseHora(pausas) || [0, 0];

        if (!inicio || !fin) return "--:--";

        const [h1, m1] = inicio;
        const [h2, m2] = fin;
        const [hp, mp] = pausa;

        const total = (h2 * 60 + m2) - (h1 * 60 + m1) - (hp * 60 + mp);
        const th = Math.floor(total / 60);
        const tm = total % 60;

        return `${String(th).padStart(2,'0')}:${String(tm).padStart(2,'0')}`;
    }

    function mostrarMensaje(msg) {
        document.getElementById("noData").innerText = msg;
        document.getElementById("noData").style.display = "block";
        document.getElementById("tablaFichajes").style.display = "none";
    }
</script>
<script src="../js/dark-mode.js" type="module"></script>

</body>
</html>
