<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestionar Usuarios</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

  <!-- Modo oscuro inicial -->
  <script>
    try {
      if (localStorage.getItem('darkMode') === 'enabled') {
        document.documentElement.classList.add('dark');
      }
    } catch(e){}
  </script>

  <!-- Estilos personalizados -->
  <style>
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #f9f9f9;
      border-radius: 0.75rem;
      max-width: 400px;
      width: 90%;
      padding: 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .dark .modal { background: #1f2937; }
    .password-field .success-tick {
      position: absolute;
      right: 0.75rem;
      top: 2.5rem;
      font-size: 1.125rem;
      color: #22c55e;
      display: none;
    }
    .error-message {
      color: #dc2626;
      font-size: 0.75rem;
      margin-top: 0.25rem;
      display: none;
    }
  </style>
</head>

<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen p-4 md:p-8">

  <div class="max-w-5xl mx-auto space-y-6">

    <!-- HEADER -->
    <div class="flex items-center gap-4 mb-6">
      <a href="../pages/admin.html" aria-label="Volver" class="text-2xl hover:text-gray-700 dark:hover:text-gray-200">&#8592;</a>
      <div>
        <h1 class="text-xl font-bold">Gestionar Usuarios</h1>
        <p class="text-sm text-gray-600 dark:text-gray-300">Buscar, editar y administrar usuarios del sistema</p>
      </div>
    </div>

    <!-- STATS -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
        <div class="text-sm text-gray-600 dark:text-gray-300">Total Usuarios</div>
        <div class="text-lg font-bold text-gray-900 dark:text-gray-100">8</div>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
        <div class="text-sm text-gray-600 dark:text-gray-300">Usuarios Activos</div>
        <div class="text-lg font-bold text-gray-900 dark:text-gray-100">7</div>
      </div>
      <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
        <div class="text-sm text-gray-600 dark:text-gray-300">Administradores</div>
        <div class="text-lg font-bold text-gray-900 dark:text-gray-100">2</div>
      </div>
    </div>

    <!-- SEARCH -->
    <div class="flex flex-wrap gap-2 items-center bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
      <label for="searchInput" class="sr-only">Buscar usuarios</label>
      <input type="text" id="searchInput" placeholder="Buscar por correo..."
             class="flex-1 px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500" />
      <label for="sortSelect" class="sr-only">Ordenar</label>
      <select id="sortSelect"
              class="px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500">
        <option value="asc">A - Z</option>
        <option value="desc">Z - A</option>
      </select>
    </div>

    <!-- USERS LIST -->
    <div id="usersList" class="space-y-4">

      <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow flex justify-between items-center" data-id="1">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center font-bold">A</div>
          <div>
            <strong class="block text-gray-900 dark:text-gray-100">Ana Rodríguez</strong>
            <div class="flex gap-2 mt-1 text-xs">
              <span class="px-2 py-0.5 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100">Usuario</span>
              <span class="px-2 py-0.5 rounded-full bg-red-600 text-white dark:bg-red-600 dark:text-white">Inactivo</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300">ana@click.com</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="delete px-3 py-1 rounded-lg border border-red-600 text-red-600 dark:border-red-500 dark:text-red-200">Eliminar</button>
          <button class="change-pass px-3 py-1 rounded-lg border border-green-700 text-green-700 dark:text-white dark:border-green-600 dark:text-white">Cambiar contraseña</button>
        </div>
      </div>

      <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow flex justify-between items-center" data-id="2">
        <div class="flex items-center gap-4">
          <div class="w-10 h-10 bg-gray-200 dark:bg-gray-600 rounded-full flex items-center justify-center font-bold">C</div>
          <div>
            <strong class="block text-gray-900 dark:text-gray-100">Carlos Martínez</strong>
            <div class="flex gap-2 mt-1 text-xs">
              <span class="px-2 py-0.5 rounded-full bg-gray-300 dark:bg-gray-700 text-gray-900 dark:text-gray-100">Usuario</span>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300">carlos@click.com</p>
          </div>
        </div>
        <div class="flex gap-2">
          <button class="delete px-3 py-1 rounded-lg border border-red-600 text-red-600 dark:border-red-500 dark:text-red-200">Eliminar</button>
          <button class="change-pass px-3 py-1 rounded-lg border border-green-700 text-green-700 dark:text-white dark:border-green-600 dark:text-white">Cambiar contraseña</button>
        </div>
      </div>

    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="modalOverlay" aria-hidden="true">
      <div class="modal rounded-xl p-6 shadow-lg">
        <h2 id="modalTitle" class="text-lg font-bold text-gray-900 dark:text-gray-100" aria-label="Nueva Contraseña"></h2>
        <p id="modalMessage" class="mt-2 text-sm text-gray-700 dark:text-gray-300"></p>

        <div id="passwordField" class="password-field mt-4 relative" style="display: none;">
          <label for="newPassword" class="text-sm font-medium text-gray-900 dark:text-gray-100">Nueva contraseña</label>
          <input id="newPassword" type="password"
                 class="w-full px-3 py-2 rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-green-500"/>
          <span class="success-tick">&#10003;</span>
          <div class="error-message" id="passwordError">Debes ingresar una contraseña</div>
        </div>

        <div class="modal-actions mt-4 flex justify-end gap-2">
          <button class="btn-cancel px-4 py-2 rounded-lg bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-gray-100" id="modalCancel">Cancelar</button>
          <button id="modalConfirm" class="px-4 py-2 rounded-lg bg-green-700 text-white dark:bg-green-600 dark:text-white">Confirmar</button>
        </div>
      </div>
    </div>

    <!-- TOAST SUCCESS -->
    <div id="passwordSuccess"
         class="fixed bottom-6 right-6 hidden bg-green-600 dark:bg-green-700 text-white px-4 py-3 rounded-lg shadow-lg">
      ✅ Contraseña guardada correctamente
    </div>

  </div>

  <!-- JS: funciones intactas -->
  <script>
    const searchInput = document.getElementById("searchInput");
    const sortSelect = document.getElementById("sortSelect");
    const usersList = document.getElementById("usersList");

    const modalOverlay = document.getElementById("modalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalMessage = document.getElementById("modalMessage");
    const modalConfirm = document.getElementById("modalConfirm");
    const modalCancel = document.getElementById("modalCancel");
    const passwordField = document.getElementById("passwordField");
    const newPasswordInput = document.getElementById("newPassword");
    const passwordError = document.getElementById("passwordError");
    const successTick = passwordField.querySelector(".success-tick");

    let currentAction = null;
    let currentTarget = null;

    // SEARCH + SORT
    function filterAndSort() {
      const filter = searchInput.value.toLowerCase();
      const cards = Array.from(usersList.children);

      cards.forEach(card => {
        card.style.display = card.innerText.toLowerCase().includes(filter) ? "" : "none";
      });

      const visible = cards.filter(c => c.style.display !== "none");
      visible.sort((a,b) => sortSelect.value === "asc" ? a.innerText.localeCompare(b.innerText) : b.innerText.localeCompare(a.innerText));
      visible.forEach(c => usersList.appendChild(c));
    }

    searchInput.addEventListener("input", filterAndSort);
    sortSelect.addEventListener("change", filterAndSort);

    // MODAL
    function openModal({ title, message, confirmText, confirmClass, action }) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalConfirm.textContent = confirmText;
      modalConfirm.className = confirmClass;
      currentAction = action;
      modalOverlay.style.display = "flex";
    }

    function closeModal() {
      modalOverlay.style.display = "none";
      passwordField.style.display = "none";
      newPasswordInput.value = "";
      newPasswordInput.classList.remove("error");
      passwordError.style.display = "none";
      successTick.style.display = "none";
    }

    modalCancel.addEventListener("click", closeModal);

    newPasswordInput.addEventListener("input", () => {
      const pass = newPasswordInput.value.trim();
      if(pass) {
        passwordError.style.display = "none";
        newPasswordInput.classList.remove("error");
        successTick.style.display = "inline";
      } else {
        successTick.style.display = "none";
      }
    });

    modalConfirm.addEventListener("click", () => {
      if(currentAction) {
        if(passwordField.style.display === "block") {
          const pass = newPasswordInput.value.trim();
          if(!pass) {
            passwordError.style.display = "block";
            newPasswordInput.classList.add("error");
            newPasswordInput.focus();
            return;
          }
          passwordError.style.display = "none";
          newPasswordInput.classList.remove("error");
          successTick.style.display = "inline";
          currentAction();
          closeModal();
        } else {
          currentAction();
          closeModal();
        }
      } else closeModal();
    });

    // USER ACTIONS
    usersList.addEventListener("click", (e) => {
      if(e.target.classList.contains("delete")) {
        currentTarget = e.target.closest(".user-card");
        openModal({
          title:"Eliminar usuario",
          message:"¿Seguro que deseas eliminar este usuario?",
          confirmText:"Eliminar",
          confirmClass:"px-4 py-2 rounded-lg bg-red-600 text-white dark:bg-red-600 dark:text-white",
          action:()=>currentTarget.remove()
        });
      }
      if(e.target.classList.contains("change-pass")) {
        const email = e.target.dataset.email;
        passwordField.style.display = "block";
        openModal({
          title:"Cambiar contraseña",
          message:"Nueva contraseña para "+email,
          confirmText:"Guardar",
          confirmClass:"px-4 py-2 rounded-lg bg-green-700 text-white dark:bg-green-700 dark:text-white",
          action: ()=>{
            const pass = newPasswordInput.value.trim();
            const successMsg = document.getElementById("passwordSuccess");
            if(!pass) return;
            console.log("Nueva contraseña:",email,pass);
            successMsg.style.display="block";
            setTimeout(()=>{ successMsg.style.display="none"; closeModal(); },3000);
          }
        });
      }
    });
  </script>

  <script src="../js/dark-mode.js" type="module"></script>
</body>
</html>
